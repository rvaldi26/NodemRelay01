<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IoT Realtime</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'danger': '#ef4444',
                        'card-bg': '#f8fafc',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans antialiased">

    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Dashboard Kontrol IoT</h1>
        <p class="text-gray-500">Monitoring Suhu, Kelembapan, dan Kontrol Relay 1 & 2</p>
    </header>

    <main class="max-w-4xl mx-auto space-y-6">
        
        <!-- Monitoring Card Section -->
        <section class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            
            <!-- Suhu (Temperature) Card -->
            <div id="suhu-card" class="bg-card-bg p-6 rounded-xl shadow-lg border-l-4 border-primary transition duration-300 hover:shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        Suhu
                    </h2>
                    <span id="suhu-value" class="text-4xl font-bold text-primary animate-pulse">-- Â°C</span>
                </div>
            </div>

            <!-- Kelembapan (Humidity) Card -->
            <div id="kelembapan-card" class="bg-card-bg p-6 rounded-xl shadow-lg border-l-4 border-secondary transition duration-300 hover:shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v5M20 20H4a2 2 0 01-2-2V8a2 2 0 012-2h4l2-2h4l2 2h4a2 2 0 012 2v10a2 2 0 01-2 2z"></path></svg>
                        Kelembapan
                    </h2>
                    <span id="kelembapan-value" class="text-4xl font-bold text-secondary animate-pulse">-- %</span>
                </div>
            </div>
        </section>

        <!-- Control Card Section -->
        <section class="bg-white p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Kontrol Relay</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Relay 1 Control -->
                <div class="p-4 border rounded-lg flex items-center justify-between">
                    <span class="text-lg font-medium text-gray-700">Relay 1</span>
                    <button id="relay1-btn" onclick="toggleRelay('relay1')"
                        class="px-6 py-3 rounded-full text-white font-semibold shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-offset-2 w-32"
                        data-status="false">
                        <span id="relay1-status-text">Memuat...</span>
                    </button>
                </div>

                <!-- Relay 2 Control -->
                <div class="p-4 border rounded-lg flex items-center justify-between">
                    <span class="text-lg font-medium text-gray-700">Relay 2</span>
                    <button id="relay2-btn" onclick="toggleRelay('relay2')"
                        class="px-6 py-3 rounded-full text-white font-semibold shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-offset-2 w-32"
                        data-status="false">
                        <span id="relay2-status-text">Memuat...</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Authentication and Debug Info -->
        <footer class="text-center pt-4 text-sm text-gray-500">
            <p>Status Koneksi: <span id="auth-status" class="font-medium text-yellow-600">Menghubungkan...</span></p>
            <p>ID Pengguna (Anonim): <span id="user-id" class="text-xs break-all">N/A</span></p>
            <p class="mt-2">Semua data disinkronkan ke Realtime Database.</p>
        </footer>

    </main>

    <!-- Firebase SDK and Script -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // 1. Firebase Configuration (From user input)
        const firebaseConfig = {
            apiKey: "AIzaSyAjOqi3AnlmgE3YfOpb3E6buG2Eo-4X7HE",
            authDomain: "esp8266-dashboard-4c605.firebaseapp.com",
            databaseURL: "https://esp8266-dashboard-4c605-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "esp8266-dashboard-4c605",
            storageBucket: "esp8266-dashboard-4c605.firebasestorage.app",
            messagingSenderId: "128119565795",
            appId: "1:128119565795:web:eeb134447f5b63b37904d6",
            measurementId: "G-RZSBMLJSNY"
        };
        
        // --- Globals ---
        let db;
        let auth;
        let userId = 'N/A';
        let dbRef; // Reference to the root of the data

        // Function to update relay button UI based on status
        function updateRelayButton(relayNumber, status) {
            const btn = document.getElementById(`relay${relayNumber}-btn`);
            const textSpan = document.getElementById(`relay${relayNumber}-status-text`);
            
            if (!btn || !textSpan) return;

            // Remove existing status classes
            btn.classList.remove('bg-secondary', 'bg-danger', 'ring-secondary', 'ring-danger', 'cursor-not-allowed', 'opacity-50');

            if (status === true) {
                // Relay ON
                btn.classList.add('bg-secondary', 'ring-secondary');
                textSpan.textContent = 'ON';
                btn.dataset.status = 'true';
                btn.disabled = false;
            } else if (status === false) {
                // Relay OFF
                btn.classList.add('bg-danger', 'ring-danger');
                textSpan.textContent = 'OFF';
                btn.dataset.status = 'false';
                btn.disabled = false;
            } else {
                // Loading/Error state
                btn.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-50');
                textSpan.textContent = 'Memuat...';
                btn.disabled = true;
                btn.dataset.status = 'loading';
            }
        }

        // 2. Main Firebase Initialization and Data Listener
        async function initializeFirebase() {
            try {
                // ADDED DEBUG LOG: Check if config is loaded correctly
                console.log("Firebase Config Loaded - Project ID:", firebaseConfig.projectId); 

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                
                // Sign in Anonymously
                await signInAnonymously(auth);
                
                // Auth State Change Listener
                onAuthStateChanged(auth, (user) => {
                    const authStatusEl = document.getElementById('auth-status');
                    const userIdEl = document.getElementById('user-id');
                    
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = 'Tersambung';
                        authStatusEl.classList.remove('text-yellow-600', 'text-danger');
                        authStatusEl.classList.add('text-secondary');
                        userIdEl.textContent = userId;

                        // Start Realtime Data Listener ONLY after authentication is ready
                        startRealtimeDataListener();

                    } else {
                        userId = 'N/A';
                        authStatusEl.textContent = 'Terputus (Anonim)';
                        authStatusEl.classList.remove('text-yellow-600', 'text-secondary');
                        authStatusEl.classList.add('text-danger');
                        userIdEl.textContent = userId;
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                // The most common cause is 'auth/configuration-not-found' if Anonymous Auth is not enabled.
                if (error.code === 'auth/configuration-not-found') {
                    document.getElementById('auth-status').textContent = `Kesalahan: Aktifkan Anonymous Auth di konsol Firebase.`;
                } else {
                    document.getElementById('auth-status').textContent = `Kesalahan: ${error.code}`;
                }
                document.getElementById('auth-status').classList.remove('text-yellow-600', 'text-secondary');
                document.getElementById('auth-status').classList.add('text-danger');
            }
        }

        // 3. Realtime Data Listener
        function startRealtimeDataListener() {
            // Note: Assuming your main data node is at the root for this simple app.
            // If you use a specific path (e.g., /sensors/dht11), change '/' to that path.
            dbRef = ref(db, '/'); 
            
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                
                // Get UI elements
                const suhuEl = document.getElementById('suhu-value');
                const kelembapanEl = document.getElementById('kelembapan-value');

                if (data) {
                    // Update Suhu (Temperature)
                    const suhu = data.suhu !== undefined ? data.suhu : '--';
                    suhuEl.textContent = `${suhu} Â°C`;

                    // Update Kelembapan (Humidity)
                    const kelembapan = data.kelembapan !== undefined ? data.kelembapan : '--';
                    kelembapanEl.textContent = `${kelembapan} %`;

                    // Update Relay UI
                    updateRelayButton(1, data.relay1);
                    updateRelayButton(2, data.relay2);

                } else {
                    // Handle empty data case
                    suhuEl.textContent = '-- Â°C';
                    kelembapanEl.textContent = '-- %';
                    updateRelayButton(1, 'loading');
                    updateRelayButton(2, 'loading');
                }
            }, (error) => {
                console.error("Error reading data from Firebase:", error);
                
                let errorMessage = `Error Data: ${error.code}`;
                
                // FIX: Specific check for permission denied error code
                if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = `KESALAHAN PERMISSION: Cek Aturan Realtime Database!`;
                    // Log specific instruction for the user to fix their rules
                    console.error("SOLUSI: Anda harus mengubah Aturan Database Firebase Realtime Anda menjadi mode 'test mode' (atau setidaknya mengizinkan read/write untuk semua) karena menggunakan sign-in anonim. Contoh rules: { 'rules': { '.read': true, '.write': true } }");
                }
                
                document.getElementById('auth-status').textContent = errorMessage;
                document.getElementById('auth-status').classList.remove('text-yellow-600', 'text-secondary');
                document.getElementById('auth-status').classList.add('text-danger');
            });
        }

        // 4. Relay Control Function (Made available globally)
        window.toggleRelay = async (relayKey) => {
            if (!dbRef) {
                console.warn("Database not ready or authenticated.");
                return;
            }
            
            const btn = document.getElementById(`${relayKey}-btn`);
            const currentStatus = btn.dataset.status === 'true';
            const newStatus = !currentStatus;

            // Temporarily disable button to prevent multiple clicks
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-wait');

            try {
                // Update the relay status in Firebase
                await update(dbRef, {
                    [relayKey]: newStatus // e.g., { relay1: true }
                });

                // The UI update (reenabling button) will be handled by the onValue listener.

            } catch (error) {
                console.error(`Error controlling ${relayKey}:`, error);
                // Note: We use a custom modal/notification in production, but here we log and suggest action.
                console.warn(`Gagal mengontrol ${relayKey}. Cek koneksi atau aturan database.`);
                
                // Re-enable button on failure
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-wait');
            }
        };

        // Initialize on page load
        initializeFirebase();
    </script>

</body>
</html>
